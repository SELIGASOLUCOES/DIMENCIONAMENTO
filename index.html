<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SolarFlow Pro</title>
    
    <!-- PWA MANIFEST -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- ESTILOS VISUAIS --- */
        :root {
            --primary: #059669; --primary-dark: #047857;
            --secondary: #d97706; --secondary-light: #fff7ed;
            --dark: #0f172a; --gray: #64748b;
            --bg: #f8fafc; --white: #ffffff;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --whatsapp: #25D366;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--dark); line-height: 1.5; padding-bottom: 60px; overscroll-behavior-y: none; }
        
        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }

        header {
            background: var(--white); padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow); border-bottom: 4px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .brand { font-size: 1.3rem; font-weight: 800; color: var(--primary); display: flex; gap: 10px; align-items: center; }
        .brand span { color: var(--dark); }

        .main-grid { display: grid; grid-template-columns: 1fr 1.6fr; gap: 20px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        .card { background: var(--white); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); height: fit-content; }
        .card-header { font-size: 1.1rem; font-weight: 700; color: var(--dark); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px; }
        .card-header i { color: var(--primary); }

        .form-group { margin-bottom: 15px; }
        .label { font-size: 0.85rem; font-weight: 600; color: var(--gray); margin-bottom: 5px; display: block; }
        .input-box { position: relative; display: flex; align-items: center; }
        .form-control {
            width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px;
            font-size: 1rem; transition: 0.2s; font-family: 'Inter', sans-serif;
        }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1); }
        .form-control[readonly] { background: #f8fafc; color: #94a3b8; cursor: not-allowed; }
        .unit { position: absolute; right: 12px; color: #94a3b8; font-size: 0.8rem; font-weight: 600; pointer-events: none; }

        .tech-box { background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        .strategy-box { background: var(--secondary-light); padding: 15px; border-radius: 8px; border: 1px solid #ffedd5; margin-bottom: 15px; }
        
        .range-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .range-title { font-size: 0.8rem; font-weight: 600; color: var(--dark); }
        .range-val { font-size: 0.8rem; font-weight: 700; color: var(--primary); }
        
        input[type=range] { width: 100%; height: 6px; border-radius: 5px; appearance: none; outline: none; background: #cbd5e1; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--primary); cursor: pointer; transition: 0.1s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .strategy-box input[type=range]::-webkit-slider-thumb { background: var(--secondary); }
        .strategy-box .range-val { color: var(--secondary); }

        .btn { border: none; padding: 14px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-icon { width: 48px; padding: 0; flex-shrink: 0; }
        .btn-gps { background: var(--secondary); color: white; }
        .btn-search { background: var(--dark); color: white; }
        .btn-sec { background: var(--dark); color: white; }
        .btn-wa { background: var(--whatsapp); color: white; }
        .btn-wa:hover { background: #128c7e; }

        .results-wrapper { opacity: 0; transform: translateY(20px); transition: 0.5s; pointer-events: none; display: none; }
        .results-wrapper.visible { opacity: 1; transform: translateY(0); pointer-events: all; display: block; }

        .kpi-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi { background: #f8fafc; padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary); }
        .kpi.money { background: #ecfdf5; border-color: var(--success); }
        .kpi-title { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: var(--gray); margin-bottom: 5px; }
        .kpi-val { font-size: 1.4rem; font-weight: 800; color: var(--dark); line-height: 1.1; }
        .kpi-sub { font-size: 0.75rem; color: #94a3b8; }
        .text-green { color: var(--primary); }

        .cons-comparison { margin: 20px 0; background: #fff; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; }
        .cons-line { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 5px; font-weight: 600; }
        .cons-track { width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; position: relative; }
        
        .tech-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-bottom: 20px; }
        .tech-table th { text-align: left; padding: 8px; color: var(--gray); border-bottom: 1px solid #e2e8f0; }
        .tech-table td { padding: 8px; color: var(--dark); border-bottom: 1px solid #e2e8f0; font-weight: 500; }
        
        .insight-item { display: flex; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .insight-icon { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; flex-shrink: 0; }
        .bg-ok { background: var(--success); } .bg-warn { background: var(--warning); } .bg-bad { background: var(--danger); }

        details.branding { background: #f0fdf4; border: 1px dashed var(--primary); padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        details.branding summary { cursor: pointer; color: var(--primary); font-weight: 600; font-size: 0.9rem; }

        .loader { width: 18px; height: 18px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            header, .no-print { display: none !important; }
            .main-grid { display: block; }
            .results-wrapper { opacity: 1; transform: none; display: block !important; }
            .card { box-shadow: none; border: 1px solid #ddd; padding: 0; margin-bottom: 20px; }
            #print-header { display: block !important; margin-bottom: 20px; text-align: center; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
        }
        #print-header { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand">
            <i class="fas fa-solar-panel"></i>
            <div>SolarFlow <span>App</span></div>
        </div>
        <div style="font-size:0.8rem; font-weight:600; color:var(--gray); text-align:right;">
            v3.0.1 Stable
        </div>
    </header>

    <div class="main-grid">
        <!-- √ÅREA DE INPUTS -->
        <div class="card no-print">
            <div class="card-header"><i class="fas fa-sliders-h"></i> Dados de Entrada</div>
            
            <form onsubmit="event.preventDefault(); calcular();">
                <details class="branding">
                    <summary>Personalizar Proposta</summary>
                    <div style="margin-top:10px;">
                        <input type="text" id="intName" class="form-control" placeholder="Nome da Sua Empresa" style="margin-bottom:8px;" onchange="saveData()">
                        <input type="number" id="intPhone" class="form-control" placeholder="WhatsApp (DDD+N√∫m)" onchange="saveData()">
                    </div>
                </details>

                <div class="form-group">
                    <label class="label">Localiza√ß√£o</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="city" class="form-control" placeholder="Cidade..." onchange="saveData()">
                        <button type="button" class="btn btn-gps btn-icon" onclick="getGPS()" title="Usar GPS Atual"><i class="fas fa-crosshairs"></i></button>
                        <button type="button" class="btn btn-search btn-icon" onclick="searchCity()" id="btnSearch" title="Buscar por nome">
                            <i class="fas fa-search" id="icoSearch"></i><div class="loader" id="spin"></div>
                        </button>
                    </div>
                    <div id="status" style="font-size:0.8rem; margin-top:4px;"></div>
                </div>

                <div class="form-group">
                    <label class="label">Irradia√ß√£o (HSP)</label>
                    <div class="input-box">
                        <input type="number" id="hsp" class="form-control" readonly placeholder="--" step="0.01">
                        <span class="unit">kWh/m¬≤.dia</span>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="form-group">
                        <label class="label">Consumo Mensal</label>
                        <div class="input-box">
                            <input type="number" id="cons" class="form-control" placeholder="0" required onchange="saveData()">
                            <span class="unit">kWh</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="label">Tarifa</label>
                        <div class="input-box">
                            <input type="number" id="tariff" class="form-control" placeholder="0.95" step="0.01" required onchange="saveData()">
                            <span class="unit">R$/kWh</span>
                        </div>
                    </div>
                </div>

                <!-- LINHA PAINEL E EFICI√äNCIA -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="form-group">
                        <label class="label">Pot√™ncia Painel</label>
                        <div class="input-box">
                            <input type="number" id="panel" class="form-control" value="550" required onchange="saveData()">
                            <span class="unit">Wp</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="label">Efici√™ncia (PR)</label>
                        <div class="input-box">
                            <input type="number" id="eff" class="form-control" value="80" required onchange="saveData()">
                            <span class="unit">%</span>
                        </div>
                    </div>
                </div>

                <!-- PAINEL DE ESTRAT√âGIA -->
                <div class="strategy-box">
                    <div style="margin-bottom:12px;">
                        <div class="range-header">
                            <span class="range-title">V√≠cio de Consumo (Conforto)</span>
                            <span class="range-val" id="vicioVal">0%</span>
                        </div>
                        <input type="range" id="vicio" min="0" max="50" value="0" oninput="document.getElementById('vicioVal').innerText=this.value+'%'; if(calculated) calcular();">
                    </div>

                    <div>
                        <div class="range-header">
                            <span class="range-title">Margem de Expans√£o</span>
                            <span class="range-val" id="expVal">0%</span>
                        </div>
                        <input type="range" id="exp" min="0" max="100" value="0" oninput="document.getElementById('expVal').innerText=this.value+'%'; if(calculated) calcular();">
                    </div>
                </div>

                <div class="tech-box">
                    <div class="range-header">
                        <span class="range-title">Overload (FDI)</span>
                        <span class="range-val" style="color:var(--dark);" id="ovVal">30%</span>
                    </div>
                    <input type="range" id="overload" min="0" max="70" value="30" oninput="document.getElementById('ovVal').innerText=this.value+'%'; if(calculated) calcular();">
                </div>

                <button class="btn btn-primary"><i class="fas fa-bolt"></i> Calcular Agora</button>
            </form>
        </div>

        <!-- √ÅREA DE RESULTADOS -->
        <div class="results-wrapper" id="resCard">
            <div id="print-header">
                <h2>Relat√≥rio T√©cnico Fotovoltaico</h2>
                <p>Dimensionamento com Proje√ß√£o de Consumo Futuro</p>
            </div>

            <div class="card">
                <div class="card-header"><i class="fas fa-chart-line"></i> An√°lise de Viabilidade</div>
                
                <div class="kpi-row">
                    <div class="kpi money">
                        <div class="kpi-title">Economia Mensal</div>
                        <div class="kpi-val text-green">R$ <span id="resSaveMonth">0,00</span></div>
                        <div class="kpi-sub">Considerando expans√£o</div>
                    </div>
                    <div class="kpi money">
                        <div class="kpi-title">Economia Anual</div>
                        <div class="kpi-val text-green">R$ <span id="resSaveYear">0,00</span></div>
                        <div class="kpi-sub">Proje√ß√£o 12 meses</div>
                    </div>
                </div>

                <div class="cons-comparison">
                    <div class="cons-line">
                        <span>Base: <span id="txtBase">0</span> kWh</span>
                        <span style="color:var(--secondary);">Proj.: <span id="txtProj">0</span> kWh</span>
                    </div>
                    <div style="display:flex; height:10px; width:100%; background:#e2e8f0; border-radius:5px; overflow:hidden;">
                        <div id="barBase" style="height:100%; background:var(--gray); width:0%;"></div>
                        <div id="barExtra" style="height:100%; background:var(--secondary); width:0%;"></div>
                    </div>
                </div>

                <div class="kpi-row">
                    <div class="kpi">
                        <div class="kpi-title">Pot√™ncia</div>
                        <div class="kpi-val"><span id="resKwp">0</span> <small style="font-size:1rem;">kWp</small></div>
                    </div>
                    <div class="kpi">
                        <div class="kpi-title">M√≥dulos</div>
                        <div class="kpi-val" id="resPanels">0</div>
                        <div class="kpi-sub">Placas</div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>
                        <h4 style="font-size:0.9rem; margin-bottom:10px;">üìã Dados T√©cnicos</h4>
                        <table class="tech-table">
                            <tr><th>Inversor</th><td id="resInv">0 kW</td></tr>
                            <tr><th>Gera√ß√£o</th><td id="resGen">0 kWh</td></tr>
                            <tr><th>√Årea</th><td id="resArea">0 m¬≤</td></tr>
                            <tr><th>Overload (FDI)</th><td id="resOv">0%</td></tr>
                        </table>
                    </div>
                    <div>
                        <h4 style="font-size:0.9rem; margin-bottom:10px;">üí° Engenharia</h4>
                        <div id="insights"></div>
                    </div>
                </div>

                <div class="action-buttons no-print" style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn btn-sec" onclick="window.print()"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="btn btn-wa" onclick="sendWA()"><i class="fab fa-whatsapp"></i> Enviar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div style="text-align:center; margin-top:40px; color:#94a3b8; font-size:0.8rem;" id="copyright">
        &copy; 2025 SolarFlow Pro
    </div>
</div>

<script>
    // --- SERVICE WORKER (PWA) - COM CORRE√á√ÉO DE ERRO ---
    if ('serviceWorker' in navigator) {
        // O .catch impede que o erro trave a aplica√ß√£o se n√£o tiver HTTPS
        navigator.serviceWorker.register('sw.js').catch(e => console.warn('SW n√£o registrado (requer HTTPS ou localhost):', e));
    }

    // --- CONFIGURA√á√ïES ---
    const API_GEO = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=";
    const API_REV = "https://nominatim.openstreetmap.org/reverse?format=json";
    const API_METEO = "https://archive-api.open-meteo.com/v1/archive";
    const INVERTERS = [1, 1.5, 2, 2.5, 3, 3.6, 4, 5, 6, 7, 8, 9, 10, 12, 15, 20, 25, 30, 33, 40, 50, 60, 75];
    let calculated = false;
    let lat = 0, lon = 0;

    // --- INICIALIZA√á√ÉO ---
    window.onload = () => {
        loadData();
        // Check de copyright simples
        setInterval(() => { if(!document.getElementById('copyright')) document.body.innerHTML = "Erro de Licen√ßa."; }, 5000);
    };

    function saveData() {
        localStorage.setItem("sf_name", document.getElementById("intName").value);
        localStorage.setItem("sf_phone", document.getElementById("intPhone").value);
        localStorage.setItem("sf_city", document.getElementById("city").value);
        localStorage.setItem("sf_cons", document.getElementById("cons").value);
        localStorage.setItem("sf_tariff", document.getElementById("tariff").value);
        localStorage.setItem("sf_panel", document.getElementById("panel").value);
        localStorage.setItem("sf_eff", document.getElementById("eff").value); // SALVA EFICIENCIA
    }
    function loadData() {
        if(localStorage.getItem("sf_name")) document.getElementById("intName").value = localStorage.getItem("sf_name");
        if(localStorage.getItem("sf_phone")) document.getElementById("intPhone").value = localStorage.getItem("sf_phone");
        if(localStorage.getItem("sf_city")) document.getElementById("city").value = localStorage.getItem("sf_city");
        if(localStorage.getItem("sf_cons")) document.getElementById("cons").value = localStorage.getItem("sf_cons");
        if(localStorage.getItem("sf_tariff")) document.getElementById("tariff").value = localStorage.getItem("sf_tariff");
        if(localStorage.getItem("sf_panel")) document.getElementById("panel").value = localStorage.getItem("sf_panel");
        if(localStorage.getItem("sf_eff")) document.getElementById("eff").value = localStorage.getItem("sf_eff"); // CARREGA EFICIENCIA
    }

    // --- GEO LOCATOR (ATUALIZADO E ROBUSTO) ---
    async function searchCity() {
        const city = document.getElementById('city').value;
        if(!city) return msg("Digite a cidade!", "red");
        loader(true);
        try {
            const r = await fetch(API_GEO + encodeURIComponent(city));
            const d = await r.json();
            if(!d.length) throw new Error("404");
            setGeo(d[0].lat, d[0].lon, d[0].display_name);
        } catch(e) { msg("N√£o encontrado. Tente outra.", "red"); manualHsp(); } 
        finally { loader(false); }
    }

    function getGPS() {
        if(!navigator.geolocation) return msg("Navegador sem GPS.", "red");
        
        loader(true);
        msg("Buscando sat√©lites...", "#d97706");

        const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };

        navigator.geolocation.getCurrentPosition(async p => {
            try {
                const {latitude, longitude} = p.coords;
                // Busca endere√ßo reverso
                const r = await fetch(`${API_REV}&lat=${latitude}&lon=${longitude}`);
                const d = await r.json();
                
                let name = d.address.city || d.address.town || d.address.municipality || "Local GPS";
                if(d.address.state) name += ` - ${d.address.state}`;
                
                setGeo(latitude, longitude, name);
            } catch(e) { 
                console.error(e);
                setGeo(p.coords.latitude, p.coords.longitude, "Localiza√ß√£o GPS"); 
            }
            finally { loader(false); }
        }, (err) => { 
            loader(false); 
            console.warn(err);
            if(err.code === 1) msg("Permiss√£o negada. Ative o GPS.", "red");
            else if(err.code === 3) msg("Tempo esgotado.", "red");
            else msg("GPS indispon√≠vel.", "red");
            manualHsp(); 
        }, options);
    }

    async function setGeo(lt, ln, name) {
        lat = lt; lon = ln;
        document.getElementById('city').value = name.split(',')[0] + " - " + (name.split(',')[1]||"").trim();
        msg("Buscando dados solares...", "#d97706");
        
        const yr = new Date().getFullYear() - 1;
        const u = `${API_METEO}?latitude=${lt}&longitude=${ln}&start_date=${yr}-01-01&end_date=${yr}-12-31&daily=shortwave_radiation_sum&timezone=auto`;
        
        try {
            const r = await fetch(u); const d = await r.json();
            if(!d.daily) throw new Error("Dados clim√°ticos offline");
            
            const sum = d.daily.shortwave_radiation_sum.reduce((a,b)=>a+b,0);
            const hsp = ((sum/d.daily.shortwave_radiation_sum.length)/3.6).toFixed(2);
            document.getElementById('hsp').value = hsp;
            msg("HSP Localizado: " + hsp, "green");
            saveData();
            if(calculated) calcular();
        } catch(e) { 
            msg("Erro clim√°tico. Digite HSP manual.", "red"); 
            manualHsp(); 
        }
    }

    // --- C√ÅLCULO DO SISTEMA ---
    function calcular() {
        const consBase = parseFloat(document.getElementById('cons').value);
        const tar = parseFloat(document.getElementById('tariff').value);
        const hsp = parseFloat(document.getElementById('hsp').value);
        const pan = parseFloat(document.getElementById('panel').value);
        const eff = parseFloat(document.getElementById('eff').value); // PEGA O VALOR DO CAMPO NOVO
        const ovTgt = parseFloat(document.getElementById('overload').value);
        const vicio = parseFloat(document.getElementById('vicio').value) / 100;
        const exp = parseFloat(document.getElementById('exp').value) / 100;
        
        // Converte efici√™ncia para decimal (ex: 80 -> 0.80) e trata erro
        const pr = (eff > 0) ? eff / 100 : 0.80; 

        if(!consBase || !hsp || !pan || !tar) return alert("Preencha todos os campos!");

        const consFinal = consBase * (1 + vicio) * (1 + exp);
        
        const reqKwp = (consFinal/30) / (hsp * pr);
        const numPan = Math.ceil((reqKwp * 1000) / pan);
        const realKwp = (numPan * pan) / 1000;
        
        const idealInv = realKwp / (1 + (ovTgt/100));
        const inv = INVERTERS.reduce((p, c) => Math.abs(c - idealInv) < Math.abs(p - idealInv) ? c : p);
        
        const realOv = ((realKwp/inv)-1)*100;
        const gen = realKwp * hsp * 30 * pr;
        
        const saveMo = gen * tar;
        const saveYr = saveMo * 12;

        setText('resKwp', realKwp.toFixed(2).replace('.', ','));
        setText('resPanels', numPan);
        setText('resInv', inv.toFixed(1).replace('.', ',') + " kW");
        setText('resGen', Math.floor(gen).toFixed(0) + " kWh");
        setText('resArea', (numPan * 2.2).toFixed(1) + " m¬≤");
        
        const ovEl = document.getElementById('resOv');
        ovEl.innerText = realOv.toFixed(1) + "%";
        ovEl.style.color = realOv > 50 ? "#ef4444" : (realOv > 35 ? "#f59e0b" : "#10b981");

        setText('resSaveMonth', saveMo.toFixed(2).replace('.', ','));
        setText('resSaveYear', saveYr.toFixed(2).replace('.', ','));

        setText('txtBase', consBase);
        setText('txtProj', Math.floor(consFinal));
        
        const basePerc = (consBase / consFinal) * 100;
        const extraPerc = 100 - basePerc;
        
        document.getElementById('barBase').style.width = basePerc + "%";
        document.getElementById('barExtra').style.width = extraPerc + "%";

        const list = document.getElementById('insights');
        list.innerHTML = "";
        
        if(vicio > 0 || exp > 0) addIns(list, "fas fa-rocket", "bg-warn", "Sobredimensionamento", `Gerando <b>${((consFinal/consBase - 1)*100).toFixed(0)}% a mais</b> que o consumo atual.`);
        
        if(realOv > 50) addIns(list, "fas fa-fire", "bg-bad", "Overload Cr√≠tico", "FDI > 50%. Perda alta.");
        else if(realOv > 30) addIns(list, "fas fa-chart-area", "bg-warn", "Clipping Estrat√©gico", "Ganho na curva vs perda no pico.");
        else addIns(list, "fas fa-check", "bg-ok", "Dimensionamento Ideal", "Sistema equilibrado.");
        
        const tlt = lat ? Math.abs(lat).toFixed(0) : 10;
        addIns(list, "fas fa-compass", "bg-ok", "Instala√ß√£o", `Face ${lat<0?"Norte":"Sul"}, Inc. ${tlt}¬∞.`);

        document.getElementById('resCard').classList.add('visible');
        calculated = true;
    }

    function addIns(to, icon, bg, tit, txt) {
        to.innerHTML += `<div class="insight-item"><div class="insight-icon ${bg}"><i class="${icon}"></i></div><div><div style="font-weight:700; font-size:0.85rem;">${tit}</div><div style="font-size:0.8rem; color:#64748b;">${txt}</div></div></div>`;
    }

    function setText(id, val) { document.getElementById(id).innerText = val; }
    function msg(t, c) { const e=document.getElementById('status'); e.innerText=t; e.style.color=c; }
    function loader(s) { 
        document.getElementById('icoSearch').style.display = s?'none':'block'; 
        document.getElementById('spin').style.display = s?'block':'none';
    }
    function manualHsp() { 
        const h = document.getElementById('hsp'); 
        h.removeAttribute('readonly'); h.focus(); h.placeholder="Digite Manual"; 
    }

    function sendWA() {
        if(!calculated) return alert("Calcule primeiro");
        const n = document.getElementById('intName').value || "SolarFlow Pro";
        const p = document.getElementById('intPhone').value;
        const base = document.getElementById('txtBase').innerText;
        const proj = document.getElementById('txtProj').innerText;

        const txt = `*‚òÄÔ∏è Proposta Estrat√©gica - ${n}*%0A%0A` +
        `üìâ *Consumo Atual:* ${base} kWh%0A` +
        `üìà *Consumo Projetado:* ${proj} kWh (Conforto + Expans√£o)%0A%0A` +
        `üí∞ *Economia Anual: R$ ${document.getElementById('resSaveYear').innerText}*%0A%0A` +
        `üõ†Ô∏è *Sistema:* ${document.getElementById('resKwp').innerText} kWp%0A` +
        `üîå *Inversor:* ${document.getElementById('resInv').innerText}%0A` +
        `‚ö° *Gera√ß√£o:* ${document.getElementById('resGen').innerText}%0A%0A` +
        `_Projeto preparado para o futuro!_`;
        
        let url = `https://wa.me/?text=${txt}`;
        if(p) url += `%0A%0Aüìû Contato: https://wa.me/55${p.replace(/\D/g,'')}`;
        window.open(url, '_blank');
    }
</script>

</body>
</html>